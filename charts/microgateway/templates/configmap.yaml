{{- $config := .Values.config -}}
{{- $simple := $config.simple -}}
{{- $advanced := $config.advanced -}}
{{- $global := $config.global -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "microgateway.fullname" . }}
  labels:
    {{- include "microgateway.labels" . | nindent 4 }}
data:
{{- if not $config.dsl }}
  config.yaml: |
    license_file: /secret/config/license
    session:
      encryption_passphrase_file: /secret/config/passphrase
    {{- if or .Values.redis.enabled $advanced.redisService }}
      {{- if $advanced.redisService }}
      redis_hosts:
        {{- range $advanced.redisService }} 
        - {{ . }}
        {{- end }}
      {{- else }}
      redis_hosts: [redis-master]
      {{- end }}
    {{- end }}
    log:
      level: {{ $advanced.logLevel }}
  {{- if or (include "microgateway.apacheExpertSettings" .) (include "microgateway.securityGateExpertSettings" .) }}
    expert_settings:
    {{- if (include "microgateway.apacheExpertSettings" .) }}
      apache: |
      {{- if $advanced.IPHeader.trustedProxies }}
        RemoteIPHeader {{ $advanced.IPHeader.header }}
        {{- range $advanced.IPHeader.trustedProxies }}
        RemoteIPInternalProxy {{ . }}
        {{- end }}
      {{- end }}
      {{- if $advanced.tls.virtualHost.protocol }}
        SSLProtocol {{ $advanced.tls.virtualHost.protocol }}
      {{- end }}
      {{- if $advanced.tls.virtualHost.cipherSuite }}
        SSLCipherSuite {{ $advanced.tls.virtualHost.cipherSuite }}
      {{- end }}
      {{- with $advanced.expert_settings.apache }}
        {{- . | nindent 8 }}
      {{- end }}
    {{- end }}
    {{- if (include "microgateway.securityGateExpertSettings" .) }}
      security_gate: |
      {{- if $advanced.tls.backend.serverCa }}
        BackendSSLServerCA /secret/tls/backend-server-validation-ca.crt
      {{- end }}
      {{- if $advanced.tls.backend.clientCert }}
        BackendSSLClientCert /secret/tls/backend-client.crt
        BackendSSLClientCertKey /secret/tls/backend-client.key
      {{- end }}
      {{- if $advanced.tls.backend.verifyHost }}
        BackendSSLVerifyHost "true"
      {{- end }}
      {{- if $advanced.tls.backend.version }}
        BackendSSLVersion {{ $advanced.tls.backend.version }}
      {{- end }}
      {{- if $advanced.tls.backend.cipherSuite }}
        BackendSSLCipherSuite {{ $advanced.tls.backend.cipherSuite }}
      {{- end }}
      {{- if $advanced.tls.backend.cipherSuitev13 }}
        BackendSSLCipherSuiteTls13 {{ $advanced.tls.backend.cipherSuitev13 }}
      {{- end }}
      {{- with $advanced.expert_settings.security_gate }}
        {{- . | nindent 8 }}
      {{- end }}
    {{- end }}
  {{- end }}

  {{- with $config.apps }}
    apps: {{ . | toYaml | nindent 4 }}
  {{- else }}
    apps:
    - mappings:
      - entry_path: {{ $simple.mapping.entryPath }}
        operational_mode: {{ $simple.mapping.operationalMode }}
        {{- if $simple.mapping.sessionHandling }}
        session_handling: {{ $simple.mapping.sessionHandling }}
        {{- else if or .Values.redis.enabled $advanced.redisService }}
        session_handling: {{ "enforce_session" }}
        {{- else }}
        session_handling: {{ "ignore_session" }}
        {{- end }}
        deny_rules:
        - enable: {{ $simple.mapping.denyRules.enabled }}
          log_only: {{ $simple.mapping.denyRules.logOnly }}
          level: {{ $simple.mapping.denyRules.level }}
      backend:
        protocol: {{ $simple.backend.protocol }}
        hostname: {{ $simple.backend.hostname }}
        port: {{ $simple.backend.port }}
    {{- if $global.tlsSecretName }}
      virtual_host:
        certificate:
          certificate_file: /secret/tls/tls.crt
          privatekey_file: /secret/tls/tls.key
          ca_chain_file: /secret/tls/ca.crt
    {{- end }}
  {{- end }}
{{- else }}
  config.yaml: |{{ toYaml $config.dsl | nindent 4 }}
{{- end }}
